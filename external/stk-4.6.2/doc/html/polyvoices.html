<HTML>
<HEAD>
<TITLE>The Synthesis ToolKit in C++ (STK)</TITLE>
<LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
</HEAD>
<BODY BGCOLOR="#FFFFFF">
<CENTER>
<img src="princeton.gif"> &nbsp; <img src="ccrma.gif"> &nbsp; <img src="mcgill.gif"><P>
<a class="qindex" href="index.html">Home</a> &nbsp; <a class="qindex" href="information.html">Information</a> &nbsp; <a class="qindex" href="classes.html">Classes</a> &nbsp; <a class="qindex" href="download.html">Download</a> &nbsp; <a class="qindex" href="usage.html">Usage</a> &nbsp; <a class="qindex" href="maillist.html">Mail List</a> &nbsp; <a class="qindex" href="system.html">Requirements</a> &nbsp; <a class="qindex" href="links.html">Links</a> &nbsp; <a class="qindex" href="faq.html">FAQ</a> &nbsp; <a class="qindex" href="tutorial.html">Tutorial</a></CENTER>
<HR>
<!-- Generated by Doxygen 1.8.3.1 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Voice Management </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The previous tutorial chapters were concerned only with monophonic ToolKit instrument playback and control. At this point, it should be relatively clear that one can instantiate multiple instruments and perhaps sum together their outputs or even direct their outputs to separate channels. It is less clear how one might go about controlling a group of instruments. The <a class="el" href="classstk_1_1Voicer.html" title="STK voice manager class.">stk::Voicer</a> class is designed to serve just this purpose.</p>
<p>The <a class="el" href="classstk_1_1Voicer.html" title="STK voice manager class.">stk::Voicer</a> class is a relatively simple voice manager. The user can dynamically add and delete instruments to/from its "control", with the option of controlling specific instruments via unique note tags and/or grouping sets of instruments via a "group" number. All sounding instrument outputs are summed and returned via the <code>tick()</code> function. The <a class="el" href="classstk_1_1Voicer.html" title="STK voice manager class.">stk::Voicer</a> class responds to noteOn, noteOff, setFrequency, pitchBend, and controlChange messages, automatically assigning incoming messages to the voices in its control. When all voices are sounding and a new noteOn is encountered, the <a class="el" href="classstk_1_1Voicer.html" title="STK voice manager class.">stk::Voicer</a> interrupts the oldest sounding voice. The user is responsible for creating and deleting all instrument instances.</p>
<p>In the following example, we modify the <code>controlbee.cpp</code> program to make use of three <a class="el" href="classstk_1_1BeeThree.html" title="STK Hammond-oid organ FM synthesis instrument.">stk::BeeThree</a> instruments, all controlled using a <a class="el" href="classstk_1_1Voicer.html" title="STK voice manager class.">stk::Voicer</a>.</p>
<div class="fragment"><div class="line"><span class="comment">// threebees.cpp STK tutorial program</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;BeeThree.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="RtAudio_8h.html">RtAudio.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Messager.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Voicer.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;SKINImsg.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;algorithm&gt;</span></div>
<div class="line"><span class="keyword">using</span> std::min;</div>
<div class="line"></div>
<div class="line"><span class="keyword">using namespace </span>stk;</div>
<div class="line"></div>
<div class="line"><span class="comment">// The TickData structure holds all the class instances and data that</span></div>
<div class="line"><span class="comment">// are shared by the various processing functions.</span></div>
<div class="line"><span class="keyword">struct </span>TickData {</div>
<div class="line">  <a class="code" href="classstk_1_1Voicer.html" title="STK voice manager class.">Voicer</a> voicer;</div>
<div class="line">  <a class="code" href="classstk_1_1Messager.html" title="STK input control message parser.">Messager</a> messager;</div>
<div class="line">  <a class="code" href="structstk_1_1Skini_1_1Message.html" title="A message structure to store and pass parsed SKINI messages.">Skini::Message</a> message;</div>
<div class="line">  <span class="keywordtype">int</span> counter;</div>
<div class="line">  <span class="keywordtype">bool</span> haveMessage;</div>
<div class="line">  <span class="keywordtype">bool</span> done;</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Default constructor.</span></div>
<div class="line">  TickData()</div>
<div class="line">    : counter(0), haveMessage(false), done( false ) {}</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define DELTA_CONTROL_TICKS 64 // default sample frames between control input checks</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// The processMessage() function encapsulates the handling of control</span></div>
<div class="line"><span class="comment">// messages.  It can be easily relocated within a program structure</span></div>
<div class="line"><span class="comment">// depending on the desired scheduling scheme.</span></div>
<div class="line"><span class="keywordtype">void</span> processMessage( TickData* data )</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">register</span> StkFloat value1 = data-&gt;message.floatValues[0];</div>
<div class="line">  <span class="keyword">register</span> StkFloat value2 = data-&gt;message.floatValues[1];</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">switch</span>( data-&gt;message.type ) {</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">case</span> __SK_Exit_:</div>
<div class="line">    data-&gt;done = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">case</span> __SK_NoteOn_:</div>
<div class="line">    <span class="keywordflow">if</span> ( value2 == 0.0 ) <span class="comment">// velocity is zero ... really a NoteOff</span></div>
<div class="line">      data-&gt;voicer.noteOff( value1, 64.0 );</div>
<div class="line">    <span class="keywordflow">else</span> { <span class="comment">// a NoteOn</span></div>
<div class="line">      data-&gt;voicer.noteOn( value1, value2 );</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">case</span> __SK_NoteOff_:</div>
<div class="line">    data-&gt;voicer.noteOff( value1, value2 );</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">case</span> __SK_ControlChange_:</div>
<div class="line">    data-&gt;voicer.controlChange( (<span class="keywordtype">int</span>) value1, value2 );</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">case</span> __SK_AfterTouch_:</div>
<div class="line">    data-&gt;voicer.controlChange( 128, value1 );</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">case</span> __SK_PitchChange_:</div>
<div class="line">    data-&gt;voicer.setFrequency( value1 );</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">case</span> __SK_PitchBend_:</div>
<div class="line">    data-&gt;voicer.pitchBend( value1 );</div>
<div class="line"></div>
<div class="line">  } <span class="comment">// end of switch</span></div>
<div class="line"></div>
<div class="line">  data-&gt;haveMessage = <span class="keyword">false</span>;</div>
<div class="line">  <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// This tick() function handles sample computation and scheduling of</span></div>
<div class="line"><span class="comment">// control updates.  It will be called automatically when the system</span></div>
<div class="line"><span class="comment">// needs a new buffer of audio samples.</span></div>
<div class="line"><span class="keywordtype">int</span> tick( <span class="keywordtype">void</span> *outputBuffer, <span class="keywordtype">void</span> *inputBuffer, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nBufferFrames,</div>
<div class="line">         <span class="keywordtype">double</span> streamTime, <a class="code" href="RtAudio_8h.html#a80e306d363583da3b0a1b65d9b57c806" title="RtAudio stream status (over- or underflow) flags.">RtAudioStreamStatus</a> status, <span class="keywordtype">void</span> *dataPointer )</div>
<div class="line">{</div>
<div class="line">  TickData *data = (TickData *) dataPointer;</div>
<div class="line">  <span class="keyword">register</span> StkFloat *samples = (StkFloat *) outputBuffer;</div>
<div class="line">  <span class="keywordtype">int</span> counter, nTicks = (int) nBufferFrames;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">while</span> ( nTicks &gt; 0 &amp;&amp; !data-&gt;done ) {</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ( !data-&gt;haveMessage ) {</div>
<div class="line">      data-&gt;messager.popMessage( data-&gt;message );</div>
<div class="line">      <span class="keywordflow">if</span> ( data-&gt;message.type &gt; 0 ) {</div>
<div class="line">        data-&gt;counter = (long) (data-&gt;message.time * <a class="code" href="classstk_1_1Stk.html#a5fbe37000a611ce56075ee7d8936472d" title="Static method that returns the current STK sample rate.">Stk::sampleRate</a>());</div>
<div class="line">        data-&gt;haveMessage = <span class="keyword">true</span>;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">        data-&gt;counter = DELTA_CONTROL_TICKS;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    counter = min( nTicks, data-&gt;counter );</div>
<div class="line">    data-&gt;counter -= counter;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i=0; i&lt;counter; i++ ) {</div>
<div class="line">      *samples++ = data-&gt;voicer.tick();</div>
<div class="line">      nTicks--;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ( nTicks == 0 ) <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Process control messages.</span></div>
<div class="line">    <span class="keywordflow">if</span> ( data-&gt;haveMessage ) processMessage( data );</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// Set the global sample rate and rawwave path before creating class instances.</span></div>
<div class="line">  <a class="code" href="classstk_1_1Stk.html#a46e2f55e5a92c717c3893fe23dde88a5" title="Static method that sets the STK sample rate.">Stk::setSampleRate</a>( 44100.0 );</div>
<div class="line">  <a class="code" href="classstk_1_1Stk.html#a4f641ad194f9d8ce1f9d1ae56af5686b" title="Static method that sets the STK rawwave path.">Stk::setRawwavePath</a>( <span class="stringliteral">&quot;../../rawwaves/&quot;</span> );</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">int</span> i;</div>
<div class="line">  TickData data;</div>
<div class="line">  <a class="code" href="classRtAudio.html" title="Realtime audio i/o C++ classes.">RtAudio</a> dac;</div>
<div class="line">  <a class="code" href="classstk_1_1Instrmnt.html" title="STK instrument abstract base class.">Instrmnt</a> *instrument[3];</div>
<div class="line">  <span class="keywordflow">for</span> ( i=0; i&lt;3; i++ ) instrument[i] = 0;</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Figure out how many bytes in an StkFloat and setup the RtAudio stream.</span></div>
<div class="line">  <a class="code" href="structRtAudio_1_1StreamParameters.html" title="The structure for specifying input or output stream parameters.">RtAudio::StreamParameters</a> parameters;</div>
<div class="line">  parameters.<a class="code" href="structRtAudio_1_1StreamParameters.html#ab3c72bcf3ef12149ae9a4fb597cc5489">deviceId</a> = dac.<a class="code" href="classRtAudio.html#a3a3f3dbe13ea696b521e49cdaaa357bc" title="A function that returns the index of the default output device.">getDefaultOutputDevice</a>();</div>
<div class="line">  parameters.<a class="code" href="structRtAudio_1_1StreamParameters.html#a88a10091b6e284e21235cc6f25332ebd">nChannels</a> = 1;</div>
<div class="line">  <a class="code" href="RtAudio_8h.html#aafca92882d25915560018873221e44b8" title="RtAudio data format type.">RtAudioFormat</a> format = ( <span class="keyword">sizeof</span>(StkFloat) == 8 ) ? RTAUDIO_FLOAT64 : RTAUDIO_FLOAT32;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bufferFrames = RT_BUFFER_SIZE;</div>
<div class="line">  <span class="keywordflow">try</span> {</div>
<div class="line">    dac.<a class="code" href="classRtAudio.html#a6907539d2527775df778ebce32ef1e3b" title="A public function for opening a stream with the specified parameters.">openStream</a>( &amp;parameters, NULL, format, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code" href="classstk_1_1Stk.html#a5fbe37000a611ce56075ee7d8936472d" title="Static method that returns the current STK sample rate.">Stk::sampleRate</a>(), &amp;bufferFrames, &amp;tick, (<span class="keywordtype">void</span> *)&amp;data );</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">catch</span> ( <a class="code" href="classRtAudioError.html" title="Exception handling class for RtAudio.">RtAudioError</a> &amp;error ) {</div>
<div class="line">    error.<a class="code" href="classRtAudioError.html#a0124bb90075cf3201865a0ea9b43a826" title="Prints thrown error message to stderr.">printMessage</a>();</div>
<div class="line">    <span class="keywordflow">goto</span> cleanup;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">try</span> {</div>
<div class="line">    <span class="comment">// Define and load the BeeThree instruments</span></div>
<div class="line">    <span class="keywordflow">for</span> ( i=0; i&lt;3; i++ )</div>
<div class="line">      instrument[i] = <span class="keyword">new</span> <a class="code" href="classstk_1_1BeeThree.html" title="STK Hammond-oid organ FM synthesis instrument.">BeeThree</a>();</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">catch</span> ( <a class="code" href="classstk_1_1StkError.html" title="STK error handling class.">StkError</a> &amp; ) {</div>
<div class="line">    <span class="keywordflow">goto</span> cleanup;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">// &quot;Add&quot; the instruments to the voicer.</span></div>
<div class="line">  <span class="keywordflow">for</span> ( i=0; i&lt;3; i++ )</div>
<div class="line">    data.voicer.addInstrument( instrument[i] );</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> ( data.messager.startStdInput() == false )</div>
<div class="line">    <span class="keywordflow">goto</span> cleanup;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">try</span> {</div>
<div class="line">    dac.<a class="code" href="classRtAudio.html#aec017a89629ccef66a90b60be22a2f80" title="A function that starts a stream.">startStream</a>();</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">catch</span> ( <a class="code" href="classRtAudioError.html" title="Exception handling class for RtAudio.">RtAudioError</a> &amp;error ) {</div>
<div class="line">    error.<a class="code" href="classRtAudioError.html#a0124bb90075cf3201865a0ea9b43a826" title="Prints thrown error message to stderr.">printMessage</a>();</div>
<div class="line">    <span class="keywordflow">goto</span> cleanup;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Block waiting until callback signals done.</span></div>
<div class="line">  <span class="keywordflow">while</span> ( !data.done )</div>
<div class="line">    <a class="code" href="classstk_1_1Stk.html#ad75619ab92a0c19b5a52cb68884511e3" title="Static cross-platform method to sleep for a number of milliseconds.">Stk::sleep</a>( 100 );</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Shut down the callback and output stream.</span></div>
<div class="line">  <span class="keywordflow">try</span> {</div>
<div class="line">    dac.<a class="code" href="classRtAudio.html#a90d599002ad32cf250a4cb866f2cc93a" title="A function that closes a stream and frees any associated stream memory.">closeStream</a>();</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">catch</span> ( <a class="code" href="classRtAudioError.html" title="Exception handling class for RtAudio.">RtAudioError</a> &amp;error ) {</div>
<div class="line">    error.<a class="code" href="classRtAudioError.html#a0124bb90075cf3201865a0ea9b43a826" title="Prints thrown error message to stderr.">printMessage</a>();</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line"> cleanup:</div>
<div class="line">  <span class="keywordflow">for</span> ( i=0; i&lt;3; i++ ) <span class="keyword">delete</span> instrument[i];</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>We have written this program to accept control messages from <code>STDIN</code>. Assuming the program is compiled as <code>threebees</code>, the three-voice SKINI scorefile <a href="tutorial/bachfugue.ski"><code>bachfugue.ski</code></a> (located in the <code>scores</code> directory with the examples) can be redirected to the program as:</p>
<div class="fragment"><div class="line">threebees &lt; scores/bachfugue.ski</div>
</div><!-- fragment --><p>For more fun, surf to <a href="http://kern.ccarh.org/">Kern Scores</a> for a huge assortment of other scorefiles that can be downloaded in the SKINI format.</p>
<p>Another easy extension would be to add the <code><a class="el" href="classstk_1_1Messager.html#a49877209a4ee08e684de82a73f2d9df9" title="Start MIDI input, with optional device and port identifiers.">stk::Messager::startMidiInput()</a></code> function to the program and then play the instruments via a MIDI keyboard.</p>
<p>[<a href="tutorial.html">Main tutorial page</a>] </p>
</div></div><!-- contents -->
<HR>
<table>
  <tr><td><A HREF="http://ccrma.stanford.edu/software/stk/"><I>The Synthesis ToolKit in C++ (STK)</I></A></td></tr>
  <tr><td>&copy;1995--2021 Perry R. Cook and Gary P. Scavone. All Rights Reserved.</td></tr>
</table>
</BODY>
</HTML>
